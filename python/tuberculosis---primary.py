# Kuan V, Denaxas S, Gonzalez-Izquierdo A, Direk K, Bhatti O, Husain S, Sutaria S, Hingorani M, Nitsch D, Parisinos C, Lumbers T, Mathur R, Sofat R, Casas JP, Wong I, Hemingway H, Hingorani A, 2023.

import sys, csv, re

codes = [{"code":"1411.00","system":"readv2"},{"code":"65Y1.00","system":"readv2"},{"code":"65Y9.00","system":"readv2"},{"code":"65Y9.11","system":"readv2"},{"code":"A1...00","system":"readv2"},{"code":"A11..11","system":"readv2"},{"code":"A110.00","system":"readv2"},{"code":"A111.00","system":"readv2"},{"code":"A112.00","system":"readv2"},{"code":"A120000","system":"readv2"},{"code":"A12y000","system":"readv2"},{"code":"A12y100","system":"readv2"},{"code":"A14y400","system":"readv2"},{"code":"A150.00","system":"readv2"},{"code":"A151.00","system":"readv2"},{"code":"A152.00","system":"readv2"},{"code":"A160.11","system":"readv2"},{"code":"A161.00","system":"readv2"},{"code":"A162.00","system":"readv2"},{"code":"A164.00","system":"readv2"},{"code":"A165000","system":"readv2"},{"code":"A165100","system":"readv2"},{"code":"A170000","system":"readv2"},{"code":"A170100","system":"readv2"},{"code":"A170200","system":"readv2"},{"code":"A170300","system":"readv2"},{"code":"A170600","system":"readv2"},{"code":"A170700","system":"readv2"},{"code":"A173.00","system":"readv2"},{"code":"A173z00","system":"readv2"},{"code":"A174.00","system":"readv2"},{"code":"A177.00","system":"readv2"},{"code":"A178.00","system":"readv2"},{"code":"A17y000","system":"readv2"},{"code":"A17y100","system":"readv2"},{"code":"A17y200","system":"readv2"},{"code":"A17y300","system":"readv2"},{"code":"A17y400","system":"readv2"},{"code":"A1z..00","system":"readv2"},{"code":"Ayu1.00","system":"readv2"},{"code":"H450.00","system":"readv2"},{"code":"K154800","system":"readv2"},{"code":"K214300","system":"readv2"},{"code":"N304300","system":"readv2"},{"code":"102673.0","system":"med"},{"code":"105288.0","system":"med"},{"code":"106521.0","system":"med"},{"code":"106837.0","system":"med"},{"code":"109312.0","system":"med"},{"code":"11975.0","system":"med"},{"code":"11976.0","system":"med"},{"code":"12338.0","system":"med"},{"code":"12448.0","system":"med"},{"code":"14913.0","system":"med"},{"code":"15158.0","system":"med"},{"code":"15693.0","system":"med"},{"code":"16265.0","system":"med"},{"code":"16331.0","system":"med"},{"code":"16367.0","system":"med"},{"code":"16414.0","system":"med"},{"code":"16582.0","system":"med"},{"code":"16741.0","system":"med"},{"code":"16996.0","system":"med"},{"code":"17153.0","system":"med"},{"code":"1840.0","system":"med"},{"code":"18950.0","system":"med"},{"code":"19652.0","system":"med"},{"code":"20333.0","system":"med"},{"code":"2193.0","system":"med"},{"code":"22011.0","system":"med"},{"code":"2208.0","system":"med"},{"code":"22572.0","system":"med"},{"code":"23451.0","system":"med"},{"code":"23472.0","system":"med"},{"code":"23940.0","system":"med"},{"code":"23962.0","system":"med"},{"code":"24372.0","system":"med"},{"code":"24413.0","system":"med"},{"code":"24517.0","system":"med"},{"code":"24626.0","system":"med"},{"code":"26344.0","system":"med"},{"code":"27399.0","system":"med"},{"code":"27611.0","system":"med"},{"code":"29395.0","system":"med"},{"code":"29482.0","system":"med"},{"code":"30358.0","system":"med"},{"code":"30687.0","system":"med"},{"code":"30945.0","system":"med"},{"code":"31349.0","system":"med"},{"code":"31409.0","system":"med"},{"code":"31436.0","system":"med"},{"code":"31445.0","system":"med"},{"code":"31670.0","system":"med"},{"code":"31680.0","system":"med"},{"code":"31844.0","system":"med"},{"code":"32180.0","system":"med"},{"code":"32459.0","system":"med"},{"code":"3273.0","system":"med"},{"code":"32899.0","system":"med"},{"code":"3303.0","system":"med"},{"code":"33372.0","system":"med"},{"code":"34430.0","system":"med"},{"code":"34640.0","system":"med"},{"code":"34657.0","system":"med"},{"code":"35443.0","system":"med"},{"code":"35760.0","system":"med"},{"code":"3596.0","system":"med"},{"code":"3720.0","system":"med"},{"code":"37329.0","system":"med"},{"code":"37422.0","system":"med"},{"code":"37492.0","system":"med"},{"code":"37598.0","system":"med"},{"code":"37694.0","system":"med"},{"code":"37834.0","system":"med"},{"code":"37886.0","system":"med"},{"code":"38110.0","system":"med"},{"code":"3830.0","system":"med"},{"code":"38342.0","system":"med"},{"code":"38920.0","system":"med"},{"code":"39279.0","system":"med"},{"code":"39512.0","system":"med"},{"code":"40231.0","system":"med"},{"code":"40522.0","system":"med"},{"code":"40605.0","system":"med"},{"code":"40990.0","system":"med"},{"code":"41051.0","system":"med"},{"code":"41208.0","system":"med"},{"code":"41383.0","system":"med"},{"code":"42201.0","system":"med"},{"code":"4247.0","system":"med"},{"code":"42479.0","system":"med"},{"code":"4256.0","system":"med"},{"code":"42630.0","system":"med"},{"code":"43370.0","system":"med"},{"code":"43791.0","system":"med"},{"code":"43976.0","system":"med"},{"code":"44039.0","system":"med"},{"code":"44128.0","system":"med"},{"code":"44129.0","system":"med"},{"code":"44573.0","system":"med"},{"code":"44655.0","system":"med"},{"code":"45318.0","system":"med"},{"code":"45861.0","system":"med"},{"code":"45932.0","system":"med"},{"code":"46019.0","system":"med"},{"code":"46039.0","system":"med"},{"code":"46044.0","system":"med"},{"code":"46147.0","system":"med"},{"code":"4621.0","system":"med"},{"code":"46272.0","system":"med"},{"code":"46383.0","system":"med"},{"code":"46675.0","system":"med"},{"code":"46727.0","system":"med"},{"code":"46802.0","system":"med"},{"code":"46926.0","system":"med"},{"code":"47016.0","system":"med"},{"code":"47336.0","system":"med"},{"code":"47430.0","system":"med"},{"code":"47832.0","system":"med"},{"code":"47881.0","system":"med"},{"code":"48580.0","system":"med"},{"code":"4907.0","system":"med"},{"code":"49112.0","system":"med"},{"code":"49235.0","system":"med"},{"code":"49433.0","system":"med"},{"code":"49481.0","system":"med"},{"code":"49503.0","system":"med"},{"code":"50147.0","system":"med"},{"code":"50261.0","system":"med"},{"code":"50489.0","system":"med"},{"code":"50837.0","system":"med"},{"code":"50869.0","system":"med"},{"code":"50902.0","system":"med"},{"code":"5101.0","system":"med"},{"code":"51110.0","system":"med"},{"code":"5145.0","system":"med"},{"code":"52199.0","system":"med"},{"code":"52272.0","system":"med"},{"code":"53331.0","system":"med"},{"code":"53473.0","system":"med"},{"code":"53548.0","system":"med"},{"code":"53701.0","system":"med"},{"code":"53864.0","system":"med"},{"code":"54570.0","system":"med"},{"code":"54579.0","system":"med"},{"code":"54840.0","system":"med"},{"code":"54908.0","system":"med"},{"code":"55298.0","system":"med"},{"code":"55629.0","system":"med"},{"code":"55835.0","system":"med"},{"code":"55957.0","system":"med"},{"code":"56670.0","system":"med"},{"code":"56771.0","system":"med"},{"code":"56833.0","system":"med"},{"code":"56890.0","system":"med"},{"code":"57126.0","system":"med"},{"code":"57398.0","system":"med"},{"code":"57417.0","system":"med"},{"code":"57466.0","system":"med"},{"code":"57587.0","system":"med"},{"code":"58588.0","system":"med"},{"code":"58673.0","system":"med"},{"code":"58827.0","system":"med"},{"code":"59087.0","system":"med"},{"code":"59202.0","system":"med"},{"code":"59916.0","system":"med"},{"code":"60040.0","system":"med"},{"code":"61442.0","system":"med"},{"code":"62033.0","system":"med"},{"code":"62468.0","system":"med"},{"code":"62530.0","system":"med"},{"code":"62963.0","system":"med"},{"code":"63351.0","system":"med"},{"code":"635.0","system":"med"},{"code":"63796.0","system":"med"},{"code":"63959.0","system":"med"},{"code":"65464.0","system":"med"},{"code":"6553.0","system":"med"},{"code":"65994.0","system":"med"},{"code":"66441.0","system":"med"},{"code":"66584.0","system":"med"},{"code":"66976.0","system":"med"},{"code":"67292.0","system":"med"},{"code":"67337.0","system":"med"},{"code":"67601.0","system":"med"},{"code":"67637.0","system":"med"},{"code":"68154.0","system":"med"},{"code":"68821.0","system":"med"},{"code":"68973.0","system":"med"},{"code":"69154.0","system":"med"},{"code":"69260.0","system":"med"},{"code":"69322.0","system":"med"},{"code":"69471.0","system":"med"},{"code":"70140.0","system":"med"},{"code":"70293.0","system":"med"},{"code":"70491.0","system":"med"},{"code":"70862.0","system":"med"},{"code":"70911.0","system":"med"},{"code":"71138.0","system":"med"},{"code":"7133.0","system":"med"},{"code":"72008.0","system":"med"},{"code":"72072.0","system":"med"},{"code":"72402.0","system":"med"},{"code":"72680.0","system":"med"},{"code":"72743.0","system":"med"},{"code":"73149.0","system":"med"},{"code":"73185.0","system":"med"},{"code":"73225.0","system":"med"},{"code":"73273.0","system":"med"},{"code":"73549.0","system":"med"},{"code":"73590.0","system":"med"},{"code":"91666.0","system":"med"},{"code":"91847.0","system":"med"},{"code":"93015.0","system":"med"},{"code":"93071.0","system":"med"},{"code":"93360.0","system":"med"},{"code":"93948.0","system":"med"},{"code":"94249.0","system":"med"},{"code":"95332.0","system":"med"},{"code":"95913.0","system":"med"},{"code":"96477.0","system":"med"},{"code":"96668.0","system":"med"},{"code":"97325.0","system":"med"},{"code":"97525.0","system":"med"},{"code":"97588.0","system":"med"},{"code":"97658.0","system":"med"},{"code":"97778.0","system":"med"},{"code":"97922.0","system":"med"},{"code":"99305.0","system":"med"},{"code":"9953.0","system":"med"},{"code":"99593.0","system":"med"},{"code":"99783.0","system":"med"},{"code":"99914.0","system":"med"},{"code":"99925.0","system":"med"}];
REQUIRED_CODES = 1;
with open(sys.argv[1], 'r') as file_in, open('tuberculosis-potential-cases.csv', 'w', newline='') as file_out:
    csv_reader = csv.DictReader(file_in)
    csv_writer = csv.DictWriter(file_out, csv_reader.fieldnames + ["tuberculosis---primary-identified"])
    csv_writer.writeheader();
    codes_identified = 0;
    for row in csv_reader:
        newRow = row.copy();
        for cell in row:
            # Iterate cell lists (e.g. codes)
            for item in re.findall(r'\(([^,]*)\,', row[cell]):
                if(item in list(map(lambda code: code['code'], codes))): codes_identified+=1;
                if(codes_identified>=REQUIRED_CODES):
                    newRow["tuberculosis---primary-identified"] = "CASE";
                    break;
            if(codes_identified>=REQUIRED_CODES): break;
        if(codes_identified<REQUIRED_CODES):
            newRow["tuberculosis---primary-identified"] = "UNK";
        codes_identified=0;
        csv_writer.writerow(newRow)
